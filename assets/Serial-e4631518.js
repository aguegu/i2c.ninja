import{y as N,r as _,A as j,B as x,C as y,D as a,J as l,L as A,F as d,K as D,M as E,O as I,P as U,Q as H,R as J}from"./index-651966c3.js";import{f as M,_ as Q,b as W}from"./index-5d79ab37.js";import{_ as S}from"./Space-96c12402.js";const z=["value"],G={name:"ComponentSerialPort"},X=Object.assign(G,{setup(V,{expose:c}){const p=N(),i=_(!1),t=_(""),f=_(""),g=new TextEncoder,k=new TextDecoder,C=_(null);let o=null,m=null,v=null;const K={baudRate:115200,dataBits:8,stopBits:1,parity:"none",flowControl:"none"},$=async()=>{const{value:r,done:e}=await m.read();if(e)return Promise.resolve();const u=k.decode(r);return p.emit("rx",u),t.value+=u,U().then(()=>{C.value.scrollTop=C.value.scrollHeight}),$()},q=async()=>{await o.open(K),i.value=!0,m=o.readable.getReader(),v=o.writable.getWriter(),$()},O=async(r=!1)=>{try{return i.value?(console.log("serial port opend already"),Promise.resolve()):((r||!o)&&(o=await navigator.serial.requestPort({filters:[{usbVendorId:6790}]})),q())}catch{return Promise.resolve()}},b=async()=>{await v.close(),await v.releaseLock(),await m.cancel(),await m.releaseLock(),await o.close(),i.value=!1,console.log("serial port closed")},R=r=>new Promise((e,u)=>{let n="";const B=`${r}\r
`,w=s=>{if(n+=s,n.indexOf(`\r
OK\r
`)>-1||n.indexOf(`\r
ERROR\r
`)>-1){p.off("rx",w);const T=n.split(`\r
`);e(W.Buffer.from(T[T.length-3],"hex"))}};p.on("rx",w),v.write(g.encode(B)).catch(u)}),F=M.promise(R,1),P=r=>F.push(r),L=async()=>{await b(),await o.forget(),o=null};return j(()=>{o&&i.value&&b()}),c({transmit:P,connect:O,disconnect:b}),(r,e)=>{const u=Q,n=E,B=S,w=I;return x(),y(w,{title:"Serial",bordered:!1},{"header-extra":a(()=>[i.value?(x(),y(B,{key:0},{default:a(()=>[l(u,{value:f.value,"onUpdate:value":e[0]||(e[0]=s=>f.value=s),type:"text",onKeyup:e[1]||(e[1]=A(s=>R(r.forms.com.tx),["enter"]))},null,8,["value"]),l(n,{onClick:e[2]||(e[2]=s=>P(f.value))},{default:a(()=>[d("Transmit")]),_:1}),l(n,{onClick:e[3]||(e[3]=s=>P("AT+SC"))},{default:a(()=>[d("Scan")]),_:1}),l(n,{onClick:e[4]||(e[4]=s=>t.value="")},{default:a(()=>[d("Clear")]),_:1}),l(n,{type:"warning",onClick:L},{default:a(()=>[d("Forget Port")]),_:1})]),_:1})):(x(),y(n,{key:1,onClick:O,type:"primary"},{default:a(()=>[d("Open Port")]),_:1}))]),default:a(()=>[D("textarea",{ref_key:"com",ref:C,value:t.value,rows:"10",readonly:"",style:{width:"100%",border:"solid 1px #ccc"}},null,8,z)]),_:1})}}}),Y={name:"ViewSerial"},ne=Object.assign(Y,{setup(V){const c=_(null);return H("adapter",{transmit:(...t)=>c.value.transmit(...t),connect:(...t)=>c.value.connect(...t),disconnect:(...t)=>c.value.disconnect(...t)}),(t,f)=>{const g=J("router-view"),k=S;return x(),y(k,{vertical:""},{default:a(()=>[l(g),l(X,{ref_key:"sp",ref:c},null,512)]),_:1})}}});export{ne as default};
