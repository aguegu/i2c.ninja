import{d as L,f as U,s as I,_ as V,a as j,b as M,c as G,e as J,g as K,h as Y,i as q,j as H,k as Q}from"./utils-0ad49ed3.js";import"./lodash-506d9b3f.js";import{r as p,T as B,z as W,P as $,U as Z,A as tt,B as h,C as w,D as t,O as et,J as e,F as _,V as at,X as st,Y as nt,K as S,M as it,G as ot}from"./index-d86c7646.js";import{_ as rt,a as lt}from"./RadioGroup-9e7d606a.js";import{_ as ct}from"./Space-bed4b1c5.js";class ut{constructor(s,i="76"){this.adapter=s,this.address=i,this.coefs={}}async init(){const[s]=await this.adapter.transmit(`AT+TR=${this.address}0D01`);if(s!==16)throw new Error(`Device at adrress 0x${this.address} IS NOT SPL06`);const[i]=await this.adapter.transmit(`AT+TR=${this.address}0801`);i&64||(await this.adapter.transmit(`AT+TX=${this.address}0c89`),await L(40)),await this.adapter.transmit(`AT+TX=${this.address}0603`),await this.adapter.transmit(`AT+TX=${this.address}0783`),await this.adapter.transmit(`AT+TX=${this.address}0807`),await this.adapter.transmit(`AT+TX=${this.address}0900`);const a=await this.adapter.transmit(`AT+TR=${this.address}1012`);this.coefs.c0=a.readInt16BE()>>4,this.coefs.c1=a.readInt32BE(1)<<4>>20,this.coefs.c00=a.readInt32BE(3)>>12,this.coefs.c10=a.readInt32BE(5)<<4>>12,this.coefs.c01=a.readInt16BE(8),this.coefs.c11=a.readInt16BE(10),this.coefs.c20=a.readInt16BE(12),this.coefs.c21=a.readInt16BE(14),this.coefs.c30=a.readInt16BE(16)}async measure(){const s=await this.adapter.transmit(`AT+TR=${this.address}0006`),i=s.readInt32BE()>>8,c=(s.readInt32BE(2)<<8>>>8)/7864320,r=i/7864320,u=this.coefs.c00+r*(this.coefs.c10+r*(this.coefs.c20+r*this.coefs.c30))+c*this.coefs.c01+c*r*(this.coefs.c11+r*this.coefs.c21),v=this.coefs.c0*.5+this.coefs.c1*c;return Promise.resolve({pressure:u,temperature:v})}}const dt={style:{position:"relative",height:"60vh"}},_t={name:"DeviceSpl06"},yt=Object.assign(_t,{setup(k){const s=p(!1),i=p(null),a=p(null),c=p(500),r=p(null),u=p("76"),v=B("emitter");let y=null,n=null;const{transmit:m,connect:E}=B("adapter"),x=async()=>{try{({pressure:a.value,temperature:i.value}=await y.measure());const d=Date.now();n.data.datasets[0].data.push({x:d,y:i.value}),n.data.datasets[1].data.push({x:d,y:a.value}),n.options.scales.x.min=I(new Date,{minutes:1});const o=n.data.datasets[1].data.findLastIndex(f=>f.x<n.options.scales.x.min);n.data.datasets[0].data.splice(0,o),n.data.datasets[1].data.splice(0,o),await $(),n.update(),s.value&&(await Q(c.value),x())}catch(d){console.log(d),s.value=!1}},D=async()=>{await E(),await m("AT"),await m("AT");const d=await m("AT+SC");if(!Array.from(d).includes(parseInt(u.value,16)))throw v.emit("message",{type:"error",data:{message:"Not Found"}}),new Error(`SPL06 at adrress 0x${u.value} NOT Found`);y=new ut({transmit:m},u.value),await y.init(),s.value=!0,x()};return W(()=>{console.log("onMounted"),$().then(()=>{n=new Z(r.value,{type:"line",data:{datasets:[{label:"Temperature",fill:!1,data:[],yAxisID:"yT"},{label:"Pressure",fill:!1,data:[],yAxisID:"yP"}]},options:{spanGaps:!0,responsive:!0,maintainAspectRatio:!1,parsing:!1,normalized:!0,animations:{numbers:{properties:["x"],type:"number",from:void 0}},scales:{x:{type:"time",min:U(I(new Date,{minutes:1})),ticks:{stepSize:5},time:{unit:"second"},title:{display:!0,text:"Date"}},yT:{title:{display:!0,text:"Celsius"},ticks:{stepSize:1,precision:1}},yP:{title:{display:!0,text:"Pascal"},ticks:{stepSize:10,precision:0},position:"right",grid:{drawOnChartArea:!1}}}}})})}),tt(()=>{n.destroy()}),(d,o)=>{const f=j,P=M,R=lt,C=rt,g=G,N=J,O=K,T=it,X=ct,A=Y,b=q,z=H,F=et;return h(),w(F,null,{header:t(()=>[e(P,null,{default:t(()=>[e(f,null,{default:t(()=>[_("Device")]),_:1}),e(f,null,{default:t(()=>[_("SPL06")]),_:1})]),_:1})]),"header-extra":t(()=>[e(X,null,{default:t(()=>[e(O,{"label-placement":"left",inline:""},{default:t(()=>[e(g,{label:"Address:"},{default:t(()=>[e(C,{value:u.value,"onUpdate:value":o[0]||(o[0]=l=>u.value=l),disabled:s.value},{default:t(()=>[(h(),at(nt,null,st(["76","77"],l=>e(R,{key:l,value:l},{default:t(()=>[_("0x"+ot(l),1)]),_:2},1032,["value"])),64))]),_:1},8,["value","disabled"])]),_:1}),e(g,{label:"Interval (ms):",style:{width:"300px"}},{default:t(()=>[e(N,{value:c.value,"onUpdate:value":o[1]||(o[1]=l=>c.value=l),step:100,min:200,max:5e3},null,8,["value"])]),_:1})]),_:1}),e(V),s.value?(h(),w(T,{key:0,onClick:o[2]||(o[2]=l=>{s.value=!1}),type:"warning"},{default:t(()=>[_("Stop")]),_:1})):(h(),w(T,{key:1,onClick:D,type:"primary"},{default:t(()=>[_("Start")]),_:1}))]),_:1})]),default:t(()=>[e(z,{"x-gap":"12",cols:2},{default:t(()=>[e(b,null,{default:t(()=>[e(A,{label:"Temperature",value:i.value},{suffix:t(()=>[_("Â°C")]),_:1},8,["value"])]),_:1}),e(b,null,{default:t(()=>[e(A,{label:"Air Pressure",value:a.value},{suffix:t(()=>[_("Pascal")]),_:1},8,["value"])]),_:1})]),_:1}),S("div",dt,[S("canvas",{ref_key:"chartRef",ref:r},null,512)])]),_:1})}}});export{yt as default};
