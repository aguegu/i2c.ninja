import{y as N,r as p,A as j,B as y,C as x,D as a,J as l,L as A,F as d,G as P,K as E,M as I,O as U,P as G,Q as H,R as J}from"./index-BK02bb7p.js";import{f as M,_ as Q,b as W}from"./index-DoEboyJW.js";import{_ as V}from"./Space-Dg0Pa17L.js";const z=["value"],X={name:"ComponentSerialPort"},Y=Object.assign(X,{setup(h,{expose:c}){const _=N(),i=p(!1),n=p(""),f=p(""),g=new TextEncoder,k=new TextDecoder,C=p(null);let r=null,m=null,v=null;const q={baudRate:115200,dataBits:8,stopBits:1,parity:"none",flowControl:"none"},O=async()=>{const{value:t,done:e}=await m.read();if(e)return Promise.resolve();const u=k.decode(t);return _.emit("rx",u),n.value+=u,G().then(()=>{C.value.scrollTop=C.value.scrollHeight}),O()},D=async()=>{await r.open(q),i.value=!0,m=r.readable.getReader(),v=r.writable.getWriter(),O()},R=async(t=!1)=>{try{return i.value?(console.log("serial port opend already"),Promise.resolve()):((t||!r)&&(r=await navigator.serial.requestPort({filters:[{usbVendorId:6790}]})),D())}catch{return Promise.resolve()}},$=async()=>{await v.close(),await v.releaseLock(),await m.cancel(),await m.releaseLock(),await r.close(),i.value=!1,console.log("serial port closed")},T=t=>new Promise((e,u)=>{let o="";const B=`${t}\r
`,w=s=>{if(o+=s,o.indexOf(`\r
OK\r
`)>-1||o.indexOf(`\r
ERROR\r
`)>-1){_.off("rx",w);const S=o.split(`\r
`);e(W.Buffer.from(S[S.length-3],"hex"))}};_.on("rx",w),v.write(g.encode(B)).catch(u)}),F=M.promise(T,1),b=t=>F.push(t),L=async()=>{await $(),await r.forget(),r=null};return j(()=>{r&&i.value&&$()}),c({transmit:b,connect:R,disconnect:$}),(t,e)=>{const u=Q,o=I,B=V,w=U;return y(),x(w,{title:t.$t("adapter.serial"),bordered:!1},{"header-extra":a(()=>[i.value?(y(),x(B,{key:0},{default:a(()=>[l(u,{value:f.value,"onUpdate:value":e[0]||(e[0]=s=>f.value=s),type:"text",onKeyup:e[1]||(e[1]=A(s=>T(t.forms.com.tx),["enter"]))},null,8,["value"]),l(o,{onClick:e[2]||(e[2]=s=>b(f.value))},{default:a(()=>[d(P(t.$t("adapter.Transmit")),1)]),_:1}),l(o,{onClick:e[3]||(e[3]=s=>b("AT+SC"))},{default:a(()=>[d("Scan")]),_:1}),l(o,{onClick:e[4]||(e[4]=s=>n.value="")},{default:a(()=>[d(P(t.$t("adapter.Clear")),1)]),_:1}),l(o,{type:"warning",onClick:L},{default:a(()=>[d("Forget Port")]),_:1})]),_:1})):(y(),x(o,{key:1,onClick:R,type:"primary"},{default:a(()=>[d(P(t.$t("adapter.Open")),1)]),_:1}))]),default:a(()=>[E("textarea",{ref_key:"com",ref:C,value:n.value,rows:"10",readonly:"",style:{width:"100%",border:"solid 1px #ccc"}},null,8,z)]),_:1},8,["title"])}}}),Z={name:"ViewSerial"},oe=Object.assign(Z,{setup(h){const c=p(null);return H("adapter",{transmit:(...n)=>c.value.transmit(...n),connect:(...n)=>c.value.connect(...n),disconnect:(...n)=>c.value.disconnect(...n)}),(n,f)=>{const g=J("router-view"),k=V;return y(),x(k,{vertical:""},{default:a(()=>[l(g),l(Y,{ref_key:"sp",ref:c},null,512)]),_:1})}}});export{oe as default};
