import{k as f,_ as M,d as T,a as P,b as Q,e as J,c as K,f as L,g as q,h as H,i as W,s as X}from"./utils-CXPfh8Vn.js";import"./lodash-Dr83-R63.js";import{r as o,U as $,z as Y,P as k,V as Z,A as tt,C as v,D as e,O as et,B as h,J as a,F as i,G as D,K as C,M as at}from"./index-BK02bb7p.js";import{_ as nt}from"./Space-Dg0Pa17L.js";class st{constructor(t){this.adapter=t,this.address="1A"}async init(){await this.adapter.transmit("AT+FQ=000E")}async deinit(){await this.adapter.transmit("AT+FQ=0190")}async version(){const t=await this.adapter.transmit(`AT+TR=${this.address}1105`);if(f(t))throw new Error("crc8 mismatch");return polarity}async measure(){let t=await this.adapter.transmit(`AT+TR=${this.address}0005`);if(f(t))throw new Error("crc8 mismatch");if(t[0]&1)throw new Error("not ready");const l=t.readUInt32BE()&16777215;if(t=await this.adapter.transmit(`AT+TR=${this.address}2005`),f(t))throw new Error("crc8 mismatch");const c=t.readUInt32BE();return Promise.resolve({tvoc:l,resistance:c})}}const ot={style:{position:"relative",height:"60vh"}},it={name:"DeviceAgs10"},_t=Object.assign(it,{setup(E){const t=o(!1),l=o(2e3),c=o(null),y=o("1A"),d=o(null),p=o(null),R=$("emitter");let m=null,s=null,w=Date.now();const{transmit:u,connect:B}=$("adapter"),g=async()=>{try{({tvoc:d.value,resistance:p.value}=await m.measure());const n=Date.now();s.data.datasets[0].data.push({x:n,y:d.value}),s.data.datasets[1].data.push({x:n,y:p.value}),n>w+50&&(w=n,k().then(()=>{s.options.scales.x.min=X(new Date,{minutes:5});const r=s.data.datasets[0].data.findLastIndex(_=>_.x<s.options.scales.x.min);s.data.datasets[0].data.splice(0,r),s.data.datasets[1].data.splice(0,r),s.update()})),t.value&&(await T(l.value),g())}catch(n){console.log(n),t.value=!1}},I=async()=>{await B(),await u("AT"),await u("AT");const n=await u("AT+SC");if(!Array.from(n).includes(parseInt(y.value,16)))throw R.emit("message",{type:"error",data:{message:"Not Found"}}),new Error(`AGS10 at adrress 0x${y.value} NOT Found`);m=new st({transmit:u}),await m.init(),t.value=!0,g()},S=async()=>(t.value=!1,await T(100),this.device.deinit());return Y(()=>{k().then(()=>{s=new Z(c.value,{type:"line",data:{datasets:[{label:"TVOC",fill:!1,data:[],yAxisID:"y0"},{label:"Resistance",fill:!1,data:[],yAxisID:"y1"}]},options:{spanGaps:!0,responsive:!0,maintainAspectRatio:!1,parsing:!1,normalized:!0,animations:{numbers:{properties:["x"],type:"number",from:void 0}},scales:{x:{type:"time",ticks:{stepSize:5},time:{unit:"second"},title:{display:!0,text:"Date"}},y0:{title:{display:!0,text:"ppm"}},y1:{title:{display:!0,text:"ohm"},position:"right"}}}})})}),tt(()=>{s.destroy()}),(n,r)=>{const _=P,F=Q,U=J,V=K,N=L,x=at,O=nt,A=q,b=H,G=W,z=et;return h(),v(z,null,{header:e(()=>[a(F,null,{default:e(()=>[a(_,null,{default:e(()=>[i("Device")]),_:1}),a(_,null,{default:e(()=>[i("AGS10")]),_:1})]),_:1})]),"header-extra":e(()=>[a(O,null,{default:e(()=>[a(N,{"label-placement":"left",inline:""},{default:e(()=>[a(V,{label:`${n.$t("adapter.Interval")} (ms)`,style:{width:"300px"}},{default:e(()=>[a(U,{value:l.value,"onUpdate:value":r[0]||(r[0]=j=>l.value=j),step:250,min:1e3,max:5e3},null,8,["value"])]),_:1},8,["label"])]),_:1}),a(M),t.value?(h(),v(x,{key:0,onClick:S,type:"warning"},{default:e(()=>[i(D(n.$t("adapter.Stop")),1)]),_:1})):(h(),v(x,{key:1,onClick:I,type:"primary"},{default:e(()=>[i(D(n.$t("adapter.Start")),1)]),_:1}))]),_:1})]),default:e(()=>[a(G,{"x-gap":"12",cols:2},{default:e(()=>[a(b,null,{default:e(()=>[a(A,{label:"TVOC",value:d.value},{suffix:e(()=>[i("ppm")]),_:1},8,["value"])]),_:1}),a(b,null,{default:e(()=>[a(A,{label:"Resistance",value:p.value},{suffix:e(()=>[i("ohm")]),_:1},8,["value"])]),_:1})]),_:1}),C("div",ot,[C("canvas",{ref_key:"chartRef",ref:c},null,512)])]),_:1})}}});export{_t as default};
