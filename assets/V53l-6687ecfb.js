import{m as T,f as P,s as g,_ as E,a as L,b as j,d as z,c as G,e as M,g as J,h as K,i as q,j as H}from"./utils-4a2a637f.js";import"./lodash-cd78795a.js";import{r as d,T as A,z as Q,P as R,U as W,A as Y,B as m,C as h,D as e,O as Z,J as s,F as l,K as $,M as tt}from"./index-b4fcf539.js";import{_ as at}from"./Space-22a2d323.js";const et=[0,1,1,1,2,0,2,8,0,8,16,1,1,0,0,0,0,255,0,15,0,0,0,0,0,32,11,0,0,2,10,33,0,0,5,0,0,0,0,200,0,0,56,255,1,0,8,0,0,1,219,15,1,241,13,1,104,0,128,8,184,0,0,0,0,15,137,0,0,0,0,0,0,0,1,15,13,14,14,0,0,2,199,255,155,0,0,0,1,0,0];class st{constructor(t,a="29"){this.adapter=t,this.address=a}async isDataReady(){const t=await this.adapter.transmit(`AT+TR=${this.address}003001`).then(a=>!(a.readUInt8()&16));return this.adapter.transmit(`AT+TR=${this.address}003101`).then(a=>!!(a.readUInt8()&1)&&t)}async clearInterrupt(){return await this.adapter.transmit(`AT+TX=${this.address}008601`)}async startRanging(){await this.clearInterrupt(),await this.adapter.transmit(`AT+TX=${this.address}008740`)}async init(){const t=await this.adapter.transmit(`AT+TR=${this.address}010f02`);if(!["eacc","ebaa"].includes(t.toString("hex")))throw new Error(`Device at adrress 0x${this.address} IS NOT V53L`);return await et.reduce(async(a,o,c)=>(await a,this.adapter.transmit(`AT+TX=${this.address}00${T(c+45)}${T(o)}`)),Promise.resolve()),this.getReady()}async waitForDataReady(){return this.isDataReady().then(t=>t?Promise.resolve():this.waitForDataReady())}async getReady(){await this.startRanging(),await this.waitForDataReady(),await this.clearInterrupt(),await this.adapter.transmit(`AT+TX=${this.address}008700`),await this.adapter.transmit(`AT+TX=${this.address}000809`),await this.adapter.transmit(`AT+TX=${this.address}000B00`)}async measureRegular(){await this.startRanging(),await this.waitForDataReady();const t=await this.adapter.transmit(`AT+TR=${this.address}009602`).then(a=>a.readUInt16BE());return await this.clearInterrupt(),await this.adapter.transmit(`AT+TX=${this.address}008700`),Promise.resolve({distance:t})}async measure(){await this.clearInterrupt(),await this.adapter.transmit(`AT+TX=${this.address}008710`),await this.waitForDataReady();const t=await this.adapter.transmit(`AT+TR=${this.address}009602`).then(a=>a.readUInt16BE());return Promise.resolve({distance:t})}}const nt={style:{position:"relative",height:"60vh"}},it={name:"DeviceBh1750"},ct=Object.assign(it,{setup(D){const t=d(!1),a=d(null),o=d(500),c=d(null),_=d("29"),b=A("emitter");let p=null,n=null,f=Date.now();const{transmit:x,connect:I}=A("adapter"),w=async()=>{try{({distance:a.value}=await p.measure());const i=Date.now();n.data.datasets[0].data.push({x:i,y:a.value}),i>f+50&&(f=i,R().then(()=>{n.options.scales.x.min=g(new Date,{minutes:1});const r=n.data.datasets[0].data.findLastIndex(u=>u.x<n.options.scales.x.min);n.data.datasets[0].data.splice(0,r),n.update()})),t.value&&(await H(o.value),w())}catch(i){console.log(i),t.value=!1}},F=async()=>{await I(),await x("AT"),await x("AT");const i=await x("AT+SC");if(!Array.from(i).includes(parseInt(_.value,16)))throw b.emit("message",{type:"error",data:{message:"Not Found"}}),new Error(`V53L at adrress 0x${_.value} NOT Found`);p=new st({transmit:x},_.value),await p.init(),t.value=!0,w()};return Q(()=>{R().then(()=>{n=new W(c.value,{type:"line",data:{datasets:[{label:"Distance",fill:!1,data:[]}]},options:{spanGaps:!0,responsive:!0,maintainAspectRatio:!1,parsing:!1,normalized:!0,animations:{numbers:{properties:["x"],type:"number",from:void 0}},scales:{x:{type:"time",min:P(g(new Date,{minutes:1})),ticks:{stepSize:5},time:{unit:"second"},title:{display:!0,text:"Date"}},y:{title:{display:!0,text:"mm"}}}}})})}),Y(()=>{n.destroy()}),(i,r)=>{const u=L,k=j,B=z,U=G,C=M,y=tt,N=at,X=J,O=K,S=q,V=Z;return m(),h(V,null,{header:e(()=>[s(k,null,{default:e(()=>[s(u,null,{default:e(()=>[l("Device")]),_:1}),s(u,null,{default:e(()=>[l("V53L")]),_:1})]),_:1})]),"header-extra":e(()=>[s(N,null,{default:e(()=>[s(C,{"label-placement":"left",inline:""},{default:e(()=>[s(U,{label:"Interval (ms):",style:{width:"300px"}},{default:e(()=>[s(B,{value:o.value,"onUpdate:value":r[0]||(r[0]=v=>o.value=v),step:100,min:0,max:1e3},null,8,["value"])]),_:1})]),_:1}),s(E),t.value?(m(),h(y,{key:0,onClick:r[1]||(r[1]=v=>{t.value=!1}),type:"warning"},{default:e(()=>[l("Stop")]),_:1})):(m(),h(y,{key:1,onClick:F,type:"primary"},{default:e(()=>[l("Start")]),_:1}))]),_:1})]),default:e(()=>[s(S,{"x-gap":"12",cols:2},{default:e(()=>[s(O,null,{default:e(()=>[s(X,{label:"Distance",value:a.value},{suffix:e(()=>[l("mm")]),_:1},8,["value"])]),_:1})]),_:1}),$("div",nt,[$("canvas",{ref_key:"chartRef",ref:c},null,512)])]),_:1})}}});export{ct as default};
