import{d as A,l as j,f as E,s as b,_ as U,a as V,b as P,e as X,c as G,g as J,h as K,i as L,j as q,k as Q}from"./utils-0ad49ed3.js";import"./lodash-506d9b3f.js";import{r as o,T as k,z as W,P as $,U as Y,A as Z,B as f,C as v,D as e,O as tt,J as a,F as l,K as C,M as et}from"./index-d86c7646.js";import{_ as at}from"./Space-bed4b1c5.js";class nt{constructor(t){this.adapter=t,this.address="38"}async init(){const[t]=await this.adapter.transmit(`AT+TR=${this.address}01`);t&8||(await this.adapter.transmit(`AT+TX=${this.address}be0800`),await A(10))}async measure(){await this.adapter.transmit(`AT+TX=${this.address}ac3308`),await A(80);const t=await this.adapter.transmit(`AT+TR=${this.address}07`);if(t[0]&128)throw new Error("Measurement not completed");const r=((t[1]<<12)+(t[2]<<4)+((t[3]&240)>>4))/(1<<20),u=(((t[3]&15)<<16)+(t[4]<<8)+t[5])/(1<<20)*200-50;if(j(t))throw new Error("crc8 mismatch");return Promise.resolve({humidity:r,temperature:u})}}const st={style:{position:"relative",height:"60vh"}},it={name:"DeviceAht21"},ct=Object.assign(it,{setup(D){const t=o(!1),r=o(null),u=o(null),d=o(500),y=o(null),p=o("38"),S=k("emitter");let m=null,n=null;const{transmit:c,connect:H}=k("adapter"),h=async()=>{try{({humidity:u.value,temperature:r.value}=await m.measure());const s=Date.now();n.data.datasets[0].data.push({x:s,y:r.value}),n.data.datasets[1].data.push({x:s,y:u.value}),n.options.scales.x.min=b(new Date,{minutes:1});const i=n.data.datasets[1].data.findLastIndex(_=>_.x<n.options.scales.x.min);n.data.datasets[0].data.splice(0,i),n.data.datasets[1].data.splice(0,i),await $(),n.update(),t.value&&(await Q(d.value),h())}catch(s){console.log(s),t.value=!1}},I=async()=>{await H(),await c("AT"),await c("AT");const s=await c("AT+SC");if(!Array.from(s).includes(parseInt(p.value,16)))throw S.emit("message",{type:"error",data:{message:"Not Found"}}),new Error(`AHT21 at adrress 0x${p.value} NOT Found`);m=new nt({transmit:c},p.value),await m.init(),t.value=!0,h()};return W(()=>{console.log("onMounted"),$().then(()=>{n=new Y(y.value,{type:"line",data:{datasets:[{label:"Temperature",fill:!1,data:[],yAxisID:"yT"},{label:"Humidity",fill:!1,data:[],yAxisID:"yH"}]},options:{spanGaps:!0,responsive:!0,maintainAspectRatio:!1,parsing:!1,normalized:!0,animations:{numbers:{properties:["x"],type:"number",from:void 0}},scales:{x:{type:"time",min:E(b(new Date,{minutes:1})),ticks:{stepSize:5},time:{unit:"second"},title:{display:!0,text:"Date"}},yT:{title:{display:!0,text:"Celsius"},ticks:{stepSize:1,precision:1}},yH:{title:{display:!0,text:"%"},ticks:{stepSize:10,precision:0},position:"right",grid:{drawOnChartArea:!1}}}}})})}),Z(()=>{n.destroy()}),(s,i)=>{const _=V,z=P,B=X,N=G,O=J,w=et,R=at,x=K,g=L,F=q,M=tt;return f(),v(M,null,{header:e(()=>[a(z,null,{default:e(()=>[a(_,null,{default:e(()=>[l("Device")]),_:1}),a(_,null,{default:e(()=>[l("AHT21")]),_:1})]),_:1})]),"header-extra":e(()=>[a(R,null,{default:e(()=>[a(O,{"label-placement":"left",inline:""},{default:e(()=>[a(N,{label:"Interval (ms):",style:{width:"300px"}},{default:e(()=>[a(B,{value:d.value,"onUpdate:value":i[0]||(i[0]=T=>d.value=T),step:100,min:200,max:5e3},null,8,["value"])]),_:1})]),_:1}),a(U),t.value?(f(),v(w,{key:0,onClick:i[1]||(i[1]=T=>{t.value=!1}),type:"warning"},{default:e(()=>[l("Stop")]),_:1})):(f(),v(w,{key:1,onClick:I,type:"primary"},{default:e(()=>[l("Start")]),_:1}))]),_:1})]),default:e(()=>[a(F,{"x-gap":"12",cols:2},{default:e(()=>[a(g,null,{default:e(()=>[a(x,{label:"Temperature",value:r.value},{suffix:e(()=>[l("Â°C")]),_:1},8,["value"])]),_:1}),a(g,null,{default:e(()=>[a(x,{label:"Air Humidity",value:u.value*100},{suffix:e(()=>[l("%")]),_:1},8,["value"])]),_:1})]),_:1}),C("div",st,[C("canvas",{ref_key:"chartRef",ref:y},null,512)])]),_:1})}}});export{ct as default};
