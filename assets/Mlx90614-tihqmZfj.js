import{l as m,k,j as I,_ as J,d as S,a as K,b as q,e as H,c as Y,f as Z,g as ee,h as te,i as ae,m as se,s as ne}from"./utils-Dax9hThb.js";import{_ as oe}from"./lodash-B4X47Vf9.js";import{T as re,r as c,U as F,z as le,P as D,V as ie,A as ue,R as ce,C as $,D as t,O as de,B as w,J as a,F as d,G as v,$ as pe,K as M,M as me}from"./index-CPfc8qSv.js";import{F as _e,f as fe}from"./FileSaver.min-DLZTFMxs.js";import{_ as ve}from"./Space-BaYJkXh7.js";class he{constructor(s,n="5A"){this.adapter=s,this.address=n,this.addressW=m(parseInt(this.address,16)<<1),this.addressR=m((parseInt(this.address,16)<<1)+1)}async readCelsius(s){const o=(await this.adapter.transmit(`AT+TR=${this.address}${s}03`)).readUInt16LE();return o>=32768?Promise.resolve(null):Promise.resolve(oe.round(o*.02-273.15,2))}async measure(){const s=await this.readCelsius("06"),n=await this.readCelsius("07");return Promise.resolve({ambient:s,target:n})}async readEmissivity(){return this.adapter.transmit(`AT+TR=${this.address}2403`).then(s=>s.readUInt16LE()/65535)}async writeEmissivity(s){const n=m(k([parseInt(this.addressW,16),36,0,0],7,0));await this.adapter.transmit(`AT+TX=${this.address}240000${n}`),await I(20);const o=parseInt(65535*s),l=[parseInt(this.addressW,16),36,o&255,o>>8],p=m(k(l,7,0));await this.adapter.transmit(`AT+TX=${this.address}${l.slice(1).map(_=>m(_)).join("")}${p}`),await I(20)}}const ge={style:{position:"relative",height:"60vh"}},ye={name:"DeviceMlx90614"},Ae=Object.assign(ye,{setup(R){const{t:s}=re({useScope:"global"}),n=c(!1),o=c(null),l=c(null),p=c(500),_=c(null),h=c("5A"),j=F("emitter"),g=[];let b=null,r=null,x=Date.now();const{transmit:u,connect:B}=F("adapter"),T=async()=>{try{({ambient:o.value,target:l.value}=await b.measure());const e=Date.now();r.data.datasets[0].data.push({x:e,y:o.value}),r.data.datasets[1].data.push({x:e,y:l.value}),g.push([fe(e,{fractionDigits:3}),o.value,l.value]),e>x+50&&(x=e,D().then(()=>{r.options.scales.x.min=ne(new Date,{minutes:1});const i=r.data.datasets[0].data.findLastIndex(f=>f.x<r.options.scales.x.min);r.data.datasets[0].data.splice(0,i),r.data.datasets[1].data.splice(0,i),r.update()})),n.value&&(await S(p.value),T())}catch(e){console.log(e),n.value=!1}},E=async()=>{await B(),await u("AT"),await u("AT"),await u("AT+FQ=0064"),await S(20);const e=await u("AT+SC");if(!Array.from(e).includes(parseInt(h.value,16)))throw j.emit("message",{type:"error",data:{message:"Not Found"}}),new Error(`MLX90614 at adrress 0x${h.value} NOT Found`);b=new he({transmit:u},h.value),n.value=!0,g.length=0,T()},L=async()=>{n.value=!1,await u("AT+FQ=0190")};le(()=>{D().then(()=>{r=new ie(_.value,{type:"line",data:{datasets:[{label:`${s("header.Ambient")} ${s("measurement.Temperature")}`,fill:!1,data:[]},{label:`${s("measurement.Target")} ${s("measurement.Temperature")}`,fill:!1,data:[]}]},options:{spanGaps:!0,responsive:!0,maintainAspectRatio:!1,parsing:!1,normalized:!0,animations:{numbers:{properties:["x"],type:"number",from:void 0}},scales:{x:{type:"time",ticks:{stepSize:5},time:{unit:"second"}},y:{title:{display:!0,text:"°C"}}}}})})});const U=()=>{const e=new Blob([`timestamp,ambient,target
`,g.map(i=>i.join(",")).join(`
`)],{type:"text/csv;charset=utf-8"});_e.saveAs(e,`MLX90614_${new Date().toISOString()}.csv`)};return ue(()=>{r.destroy()}),(e,i)=>{const f=K,N=q,X=H,O=Y,P=Z,y=me,V=ce("svg-icon"),z=ve,A=ee,C=te,W=ae,G=de;return w(),$(G,null,{header:t(()=>[a(N,null,{default:t(()=>[a(f,null,{default:t(()=>[d(v(e.$t("header.Ambient"))+v(e.$t("adapter.Sensor")),1)]),_:1}),a(f,null,{default:t(()=>[d("MLX90614")]),_:1})]),_:1})]),"header-extra":t(()=>[a(z,null,{default:t(()=>[a(P,{"label-placement":"left",inline:""},{default:t(()=>[a(O,{label:`${e.$t("adapter.Interval")} (ms)`,style:{width:"300px"}},{default:t(()=>[a(X,{value:p.value,"onUpdate:value":i[0]||(i[0]=Q=>p.value=Q),step:100,min:0,max:1e3},null,8,["value"])]),_:1},8,["label"])]),_:1}),a(J),n.value?(w(),$(y,{key:0,onClick:L,type:"warning"},{default:t(()=>[d(v(e.$t("adapter.Stop")),1)]),_:1})):(w(),$(y,{key:1,onClick:E,type:"primary"},{default:t(()=>[d(v(e.$t("adapter.Start")),1)]),_:1})),a(y,{onClick:U},{icon:t(()=>[a(V,{type:"mdi",path:pe(se)},null,8,["path"])]),_:1})]),_:1})]),default:t(()=>[a(W,{"x-gap":"12",cols:2},{default:t(()=>[a(C,null,{default:t(()=>[a(A,{label:`${e.$t("header.Ambient")} ${e.$t("measurement.Temperature")}`,value:o.value},{suffix:t(()=>[d("°C")]),_:1},8,["label","value"])]),_:1}),a(C,null,{default:t(()=>[a(A,{label:`${e.$t("measurement.Target")} ${e.$t("measurement.Temperature")}`,value:l.value},{suffix:t(()=>[d("°C")]),_:1},8,["label","value"])]),_:1})]),_:1}),M("div",ge,[M("canvas",{ref_key:"chartRef",ref:_},null,512)])]),_:1})}}});export{Ae as default};
