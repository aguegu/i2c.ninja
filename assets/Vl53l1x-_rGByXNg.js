import{l as T,j as O,_ as P,a as E,b as j,e as z,c as G,f as M,g as J,h as K,i as q,s as H,d as Q}from"./utils-Dax9hThb.js";import"./lodash-B4X47Vf9.js";import{r as l,U as g,z as W,P as $,V as Y,A as Z,C as m,D as e,O as tt,B as h,J as n,F as d,G as A,K as R,M as at}from"./index-CPfc8qSv.js";import{_ as et}from"./Space-BaYJkXh7.js";const st=[0,1,1,1,2,0,2,8,0,8,16,1,1,0,0,0,0,255,0,15,0,0,0,0,0,32,11,0,0,2,10,33,0,0,5,0,0,0,0,200,0,0,56,255,1,0,8,0,0,1,219,15,1,241,13,1,104,0,128,8,184,0,0,0,0,15,137,0,0,0,0,0,0,0,1,15,13,14,14,0,0,2,199,255,155,0,0,0,1,0,0];class nt{constructor(t,a="29"){this.adapter=t,this.address=a}async isDataReady(){const t=await this.adapter.transmit(`AT+TR=${this.address}003001`).then(a=>!(a.readUInt8()&16));return this.adapter.transmit(`AT+TR=${this.address}003101`).then(a=>!!(a.readUInt8()&1)&&t)}async clearInterrupt(){return this.adapter.transmit(`AT+TX=${this.address}008601`)}async startRanging(){await this.clearInterrupt(),await this.adapter.transmit(`AT+TX=${this.address}008740`)}async init(){const t=await this.adapter.transmit(`AT+TR=${this.address}010f02`);if(!["eacc","ebaa"].includes(t.toString("hex")))throw new Error(`Device at adrress 0x${this.address} IS NOT V53L`);return await st.reduce(async(a,o,c)=>(await a,this.adapter.transmit(`AT+TX=${this.address}00${T(c+45)}${T(o)}`)),Promise.resolve()),this.getReady()}async waitForDataReady(){return this.isDataReady().then(t=>t?Promise.resolve():this.waitForDataReady())}async getReady(){await this.startRanging(),await this.waitForDataReady(),await this.clearInterrupt(),await this.adapter.transmit(`AT+TX=${this.address}008700`),await this.adapter.transmit(`AT+TX=${this.address}000809`),await this.adapter.transmit(`AT+TX=${this.address}000B00`)}async measureRegular(){await this.startRanging(),await this.waitForDataReady();const t=await this.adapter.transmit(`AT+TR=${this.address}009602`).then(a=>a.readUInt16BE());return await this.clearInterrupt(),await this.adapter.transmit(`AT+TX=${this.address}008700`),Promise.resolve({distance:t})}async measure(){await this.clearInterrupt(),await this.adapter.transmit(`AT+TX=${this.address}008710`),await O(112);const t=await this.adapter.transmit(`AT+TR=${this.address}009602`).then(a=>a.readUInt16BE());return Promise.resolve({distance:t})}}const it={style:{position:"relative",height:"60vh"}},rt={name:"DeviceVl53l1x"},xt=Object.assign(rt,{setup(b){const t=l(!1),a=l(null),o=l(500),c=l(null),_=l("29"),D=g("emitter");let p=null,i=null,f=Date.now();const{transmit:x,connect:I}=g("adapter"),w=async()=>{try{({distance:a.value}=await p.measure());const s=Date.now();i.data.datasets[0].data.push({x:s,y:a.value}),s>f+50&&(f=s,$().then(()=>{i.options.scales.x.min=H(new Date,{minutes:1});const r=i.data.datasets[0].data.findLastIndex(u=>u.x<i.options.scales.x.min);i.data.datasets[0].data.splice(0,r),i.update()})),t.value&&(await Q(o.value),w())}catch(s){console.log(s),t.value=!1}},F=async()=>{await I(),await x("AT"),await x("AT");const s=await x("AT+SC");if(!Array.from(s).includes(parseInt(_.value,16)))throw D.emit("message",{type:"error",data:{message:"Not Found"}}),new Error(`VL53L1X at adrress 0x${_.value} NOT Found`);p=new nt({transmit:x},_.value),await p.init(),t.value=!0,w()};return W(()=>{$().then(()=>{i=new Y(c.value,{type:"line",data:{datasets:[{label:"Distance",fill:!1,data:[]}]},options:{spanGaps:!0,responsive:!0,maintainAspectRatio:!1,parsing:!1,normalized:!0,animations:{numbers:{properties:["x"],type:"number",from:void 0}},scales:{x:{type:"time",ticks:{stepSize:5},time:{unit:"second"},title:{display:!0,text:"Date"}},y:{title:{display:!0,text:"mm"}}}}})})}),Z(()=>{i.destroy()}),(s,r)=>{const u=E,k=j,U=z,X=G,B=M,y=at,V=et,C=J,N=K,L=q,S=tt;return h(),m(S,null,{header:e(()=>[n(k,null,{default:e(()=>[n(u,null,{default:e(()=>[d("Device")]),_:1}),n(u,null,{default:e(()=>[d("VL53L1X")]),_:1})]),_:1})]),"header-extra":e(()=>[n(V,null,{default:e(()=>[n(B,{"label-placement":"left",inline:""},{default:e(()=>[n(X,{label:`${s.$t("adapter.Interval")} (ms)`,style:{width:"300px"}},{default:e(()=>[n(U,{value:o.value,"onUpdate:value":r[0]||(r[0]=v=>o.value=v),step:100,min:0,max:1e3},null,8,["value"])]),_:1},8,["label"])]),_:1}),n(P),t.value?(h(),m(y,{key:0,onClick:r[1]||(r[1]=v=>{t.value=!1}),type:"warning"},{default:e(()=>[d(A(s.$t("adapter.Stop")),1)]),_:1})):(h(),m(y,{key:1,onClick:F,type:"primary"},{default:e(()=>[d(A(s.$t("adapter.Start")),1)]),_:1}))]),_:1})]),default:e(()=>[n(L,{"x-gap":"12",cols:2},{default:e(()=>[n(N,null,{default:e(()=>[n(C,{label:"Distance",value:a.value},{suffix:e(()=>[d("mm")]),_:1},8,["value"])]),_:1})]),_:1}),R("div",it,[R("canvas",{ref_key:"chartRef",ref:c},null,512)])]),_:1})}}});export{xt as default};
