import{d as U,f as j,s as B,_ as V,a as M,b as G,c as J,e as K,g as Y,h as q,i as H,j as Q,k as W}from"./utils-f6224475.js";import"./lodash-69779c74.js";import{r as p,T as $,z as Z,P as S,U as tt,A as et,B as h,C as x,D as t,O as at,J as e,F as _,V as st,X as nt,Y as it,K as k,M as ot,G as rt}from"./index-651966c3.js";import{_ as lt,a as ct}from"./RadioGroup-70983653.js";import{_ as ut}from"./Space-96c12402.js";class dt{constructor(s,o="76"){this.adapter=s,this.address=o,this.coefs={}}async init(){const[s]=await this.adapter.transmit(`AT+TR=${this.address}0D01`);if(s!==16)throw new Error(`Device at adrress 0x${this.address} IS NOT SPL06`);const[o]=await this.adapter.transmit(`AT+TR=${this.address}0801`);o&64||(await this.adapter.transmit(`AT+TX=${this.address}0c89`),await U(40)),await this.adapter.transmit(`AT+TX=${this.address}0603`),await this.adapter.transmit(`AT+TX=${this.address}0783`),await this.adapter.transmit(`AT+TX=${this.address}0807`),await this.adapter.transmit(`AT+TX=${this.address}0900`);const a=await this.adapter.transmit(`AT+TR=${this.address}1012`);this.coefs.c0=a.readInt16BE()>>4,this.coefs.c1=a.readInt32BE(1)<<4>>20,this.coefs.c00=a.readInt32BE(3)>>12,this.coefs.c10=a.readInt32BE(5)<<4>>12,this.coefs.c01=a.readInt16BE(8),this.coefs.c11=a.readInt16BE(10),this.coefs.c20=a.readInt16BE(12),this.coefs.c21=a.readInt16BE(14),this.coefs.c30=a.readInt16BE(16)}async measure(){const s=await this.adapter.transmit(`AT+TR=${this.address}0006`),o=s.readInt32BE()>>8,u=(s.readInt32BE(2)<<8>>>8)/7864320,l=o/7864320,d=this.coefs.c00+l*(this.coefs.c10+l*(this.coefs.c20+l*this.coefs.c30))+u*this.coefs.c01+u*l*(this.coefs.c11+l*this.coefs.c21),v=this.coefs.c0*.5+this.coefs.c1*u;return Promise.resolve({pressure:d,temperature:v})}}const _t={style:{position:"relative",height:"60vh"}},pt={name:"DeviceSpl06"},xt=Object.assign(pt,{setup(E){const s=p(!1),o=p(null),a=p(null),u=p(500),l=p(null),d=p("76"),v=$("emitter");let y=null,n=null,w=Date.now();const{transmit:m,connect:D}=$("adapter"),g=async()=>{try{({pressure:a.value,temperature:o.value}=await y.measure());const i=Date.now();n.data.datasets[0].data.push({x:i,y:o.value}),n.data.datasets[1].data.push({x:i,y:a.value}),i>w+50&&(w=i,S().then(()=>{n.options.scales.x.min=B(i,{minutes:1});const r=n.data.datasets[0].data.findLastIndex(f=>f.x<n.options.scales.x.min);n.data.datasets[0].data.splice(0,r),n.data.datasets[1].data.splice(0,r),n.update()})),s.value&&(await W(u.value),g())}catch(i){console.log(i),s.value=!1}},P=async()=>{await D(),await m("AT"),await m("AT");const i=await m("AT+SC");if(!Array.from(i).includes(parseInt(d.value,16)))throw v.emit("message",{type:"error",data:{message:"Not Found"}}),new Error(`SPL06 at adrress 0x${d.value} NOT Found`);y=new dt({transmit:m},d.value),await y.init(),s.value=!0,g()};return Z(()=>{console.log("onMounted"),S().then(()=>{n=new tt(l.value,{type:"line",data:{datasets:[{label:"Temperature",fill:!1,data:[],yAxisID:"yT"},{label:"Pressure",fill:!1,data:[],yAxisID:"yP"}]},options:{spanGaps:!0,responsive:!0,maintainAspectRatio:!1,parsing:!1,normalized:!0,animations:{numbers:{properties:["x"],type:"number",from:void 0}},scales:{x:{type:"time",min:j(B(new Date,{minutes:1})),ticks:{major:{enabled:!0},stepSize:5},time:{unit:"second"},title:{display:!0,text:"Date"}},yT:{title:{display:!0,text:"Celsius"},ticks:{stepSize:1,precision:1}},yP:{title:{display:!0,text:"Pascal"},ticks:{stepSize:10,precision:0},position:"right",grid:{drawOnChartArea:!1}}}}})})}),et(()=>{n.destroy()}),(i,r)=>{const f=M,C=G,R=ct,N=lt,T=J,O=K,X=Y,A=ot,z=ut,b=q,I=H,F=Q,L=at;return h(),x(L,null,{header:t(()=>[e(C,null,{default:t(()=>[e(f,null,{default:t(()=>[_("Device")]),_:1}),e(f,null,{default:t(()=>[_("SPL06")]),_:1})]),_:1})]),"header-extra":t(()=>[e(z,null,{default:t(()=>[e(X,{"label-placement":"left",inline:""},{default:t(()=>[e(T,{label:"Address:"},{default:t(()=>[e(N,{value:d.value,"onUpdate:value":r[0]||(r[0]=c=>d.value=c),disabled:s.value},{default:t(()=>[(h(),st(it,null,nt(["76","77"],c=>e(R,{key:c,value:c},{default:t(()=>[_("0x"+rt(c),1)]),_:2},1032,["value"])),64))]),_:1},8,["value","disabled"])]),_:1}),e(T,{label:"Interval (ms):",style:{width:"300px"}},{default:t(()=>[e(O,{value:u.value,"onUpdate:value":r[1]||(r[1]=c=>u.value=c),step:100,min:400,max:5e3},null,8,["value"])]),_:1})]),_:1}),e(V),s.value?(h(),x(A,{key:0,onClick:r[2]||(r[2]=c=>{s.value=!1}),type:"warning"},{default:t(()=>[_("Stop")]),_:1})):(h(),x(A,{key:1,onClick:P,type:"primary"},{default:t(()=>[_("Start")]),_:1}))]),_:1})]),default:t(()=>[e(F,{"x-gap":"12",cols:2},{default:t(()=>[e(I,null,{default:t(()=>[e(b,{label:"Temperature",value:o.value},{suffix:t(()=>[_("Â°C")]),_:1},8,["value"])]),_:1}),e(I,null,{default:t(()=>[e(b,{label:"Air Pressure",value:a.value},{suffix:t(()=>[_("Pascal")]),_:1},8,["value"])]),_:1})]),_:1}),k("div",_t,[k("canvas",{ref_key:"chartRef",ref:l},null,512)])]),_:1})}}});export{xt as default};
